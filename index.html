<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy Birthday, My Love â™¡</title>
  <meta name="description" content="For the one I love â€” a tiny website full of our memories." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fff7fb; --ink:#3b2a2f; --ink-soft:#6a4b55; --primary:#ff6fa3; --accent:#ffd1e1; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
         background:radial-gradient(1200px 800px at 80% -100px, #ffe3ef 10%, transparent 50%),
                    radial-gradient(1000px 600px at -20% -200px, #ffeef6 10%, transparent 50%), var(--bg);}
    a{color:var(--primary)}
    .container{max-width:960px; margin:0 auto; padding:24px}
    header{display:flex; flex-direction:column; align-items:center; gap:8px; padding:56px 16px 32px}
    .script{font-family:"Great Vibes", cursive; font-size:56px; line-height:1; color:#ef3f7f; text-shadow:0 2px 0 #fff}
    .sub{opacity:.8}
    .btn{display:inline-flex; align-items:center; gap:8px; border:none; border-radius:999px; padding:12px 18px;
         background:var(--primary); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 8px 20px rgba(255,111,163,.35); transition:transform .1s ease}
    .btn:hover{transform:translateY(-1px)}
    .pill{background:var(--accent); color:#8a4a62; padding:6px 12px; border-radius:999px; font-weight:600; display:inline-block}
    .card{background:#fff; border:1px solid #f5dbe6; border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(255,111,163,.08)}
    .grid{display:grid; gap:16px}
    .grid.m2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.m3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:720px){ .grid.m2,.grid.m3{grid-template-columns:1fr} header{padding-top:36px} .script{font-size:44px}}

    /* Typewriter */
    .type{border-right:2px solid var(--primary); white-space:nowrap; overflow:hidden}

    /* Timeline */
    .timeline{position:relative; margin:24px 0}
    .timeline:before{content:""; position:absolute; left:calc(12px + .5rem); top:0; bottom:0; width:3px; background:linear-gradient(var(--primary),#ffc3d6)}
    .t-item{position:relative; padding-left:56px; margin:22px 0}
    .t-dot{position:absolute; width:22px; height:22px; border-radius:50%; left:0; top:2px; background:#fff; border:4px solid var(--primary); box-shadow:0 4px 20px rgba(255,111,163,.3)}

    /* Gallery */
    .gallery{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px}
    .gallery img{width:100%; height:200px; object-fit:cover; border-radius:14px; transition:transform .2s ease; cursor:pointer}
    .gallery img:hover{transform:translateY(-2px)}
    @media (max-width:720px){ .gallery{grid-template-columns:repeat(2,1fr)} }
    
    /* Lightbox */
    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:40}
    .lightbox.open{display:flex}
    .lightbox img{max-width:90vw; max-height:80vh; border-radius:12px}

    /* Floating hearts */
    .hearts{pointer-events:none; position:fixed; inset:0; overflow:hidden; z-index:10}
    .heart{position:absolute; width:14px; height:14px; transform:rotate(45deg); background:var(--primary); opacity:.6; animation:float 6s linear forwards}
    .heart:before,.heart:after{content:""; position:absolute; width:14px; height:14px; background:var(--primary); border-radius:50%}
    .heart:before{left:-7px}
    .heart:after{top:-7px}
    @keyframes float{0%{transform:translateY(0) rotate(45deg)} 100%{transform:translateY(-120vh) rotate(45deg); opacity:0}}

    /* Fireworks on click */
    canvas#fx{position:fixed; inset:0; pointer-events:none; z-index:20}

    footer{padding:48px 0 72px; text-align:center; opacity:.8}

    /* Heart collage */
    .heart-topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .heart-wrap{display:flex; justify-content:center}
    .heart-wall{
      position:relative; width:min(92vw, 820px); aspect-ratio:1/1; 
      overflow:hidden; border-radius:24px; background:#fff;
      border:1px solid #f5dbe6; box-shadow:0 10px 30px rgba(255,111,163,.08);
    }
    .heart-tile{
      position:absolute; transform:translate(-50%,-50%) rotate(var(--r,0deg));
      border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.08);
      transition:transform .15s ease;
    }
    .heart-tile:hover{ transform:translate(-50%,-50%) rotate(var(--r,0deg)) scale(1.03); }
    .heart-tile img{ width:100%; height:100%; object-fit:cover; display:block }
    @media (max-width:720px){ .heart-wall{ width:92vw } }

    /* Debug panel */
    details.debug{margin-top:8px}
    details.debug summary{cursor:pointer; user-select:none; color:#8a4a62}
    .mini{font-size:12px; opacity:.8}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; background:#ffe6ef; margin-right:6px; margin-bottom:6px}
    .chip.ok{background:#e8f9ed; color:#1a7f3c; border:1px solid #b7e3c2}
    .chip.fail{background:#fff0f3; color:#b11a3c; border:1px solid #f6c2cf}
  </style>
</head>
<body>
  <div class="hearts" aria-hidden="true"></div>
  <canvas id="fx"></canvas>

  <header class="container">
    <span class="pill">ğŸ‚ Happy Birthday</span>
    <h1 class="script">ç»™æœ€çˆ±çš„ä½ </h1>
    <p class="type" id="typewriter"></p>
    <div style="display:flex; gap:10px; margin-top:18px; flex-wrap:wrap">
      <button class="btn" id="playBtn">ğŸµ æ’­æ”¾/æš‚åœæˆ‘ä»¬çš„æ­Œ</button>
      <button class="btn" id="confettiBtn">ğŸ‰ å°æƒŠå–œ</button>
    </div>
    <p class="sub">å€’è®¡æ—¶ï¼š<span id="countdown">--:--:--</span></p>
  </header>

  <main class="container" style="display:grid; gap:28px">
    <!-- Love Letter -->
    <section class="card">
      <h2 style="margin:0 0 8px">ä¸€å°å°æƒ…ä¹¦ ğŸ’Œ</h2>
      <p style="margin:0; line-height:1.8">
        äº²çˆ±çš„ <strong>å°æ³½è¡£</strong>ï¼Œ<br/>
        è¿™ä¸€é¡µï¼Œè—ç€æˆ‘æƒ³è¯´çš„æ¯ä¸€å¥æ‚„æ‚„è¯ã€‚è°¢è°¢ä½ å‡ºç°åœ¨æˆ‘çš„æ—¥å¸¸é‡Œï¼Œè®©æ™®é€šçš„æ—¥å­éƒ½å˜å¾—å‘å…‰ã€‚æ„¿ä½ çš„æ¯ä¸€ä¸ªæ„¿æœ›ï¼Œéƒ½æœ‰äººä¸ºä½ ç‚¹äº®ã€‚<br/>
        <em>â€”â€” X </em>
      </p>
    </section>

    <!-- Timeline -->
    <section class="card">
      <h2 style="margin:0 0 8px">Our Story Â· æˆ‘ä»¬çš„æ—¶é—´çº¿ â³</h2>
      <div class="timeline">
        <div class="t-item">
          <div class="t-dot"></div>
          <h3 style="margin:0">ç¬¬ä¸€æ¬¡è§é¢ <small style="opacity:.6">2023-08-23</small></h3>
          <p style="margin:.25rem 0 0">é‚£å¤©çš„é£å¾ˆæ¸©æŸ”ï¼Œä½ çš„ç¬‘ä¹Ÿå¾ˆæ¸©æŸ”ã€‚</p>
        </div>
        <div class="t-item">
          <div class="t-dot"></div>
          <h3 style="margin:0">ä»Šå¤© Â· ç”Ÿæ—¥å¿«ä¹ <small style="opacity:.6" id="todayLabel"></small></h3>
          <p style="margin:.25rem 0 0">æ„¿ä½ æ­¤åæ¯ä¸€å¹´ï¼Œéƒ½è¢«æ¸©æŸ”ä»¥å¾…ã€‚</p>
        </div>
      </div>
    </section>

    <!-- Gallery (auto from image/) -->
    <section class="card">
      <h2 style="margin:0 0 8px">ç›¸å†Œ Â· Our Gallery ğŸ“·</h2>
      <p class="sub" style="margin:0 0 10px">
        ä¼˜å…ˆç”¨â€œä»æ–‡ä»¶å¤¹é€‰æ‹©â€è¯»å–æœ¬åœ°å›¾ç‰‡ï¼›è‹¥ä¸é€‰æ‹©ï¼Œå°†è‡ªåŠ¨å°è¯•åŒ¹é… <code>image/</code> ä¸‹å¸¸è§å‘½åï¼ˆ1ã€01ã€001ã€IMG_001ã€DSC_001 ç­‰ï¼‰ã€‚
      </p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px">
        <label class="btn" for="dirInput">ğŸ“ ä»æ–‡ä»¶å¤¹é€‰æ‹©</label>
        <input id="dirInput" type="file" webkitdirectory directory multiple accept="image/*" style="display:none" />
        <button class="btn" id="reshuffleBtn">ğŸ” æ¢ä¸€ç»„</button>
        <span class="mini">å·²åŠ è½½ï¼š<b id="countLoaded">0</b> å¼ </span>
      </div>
      <div class="gallery" id="gallery"></div>
      <div class="lightbox" id="lightbox"><img alt="preview" /></div>

      <details class="debug">
        <summary>ğŸ›  è°ƒè¯•ä¿¡æ¯ï¼ˆå±•å¼€æŸ¥çœ‹ï¼‰</summary>
        <div class="mini" id="debugBox"></div>
      </details>
    </section>

    <!-- Heart Collage -->
    <section class="card">
      <h2 style="margin:0 0 8px">çˆ±å¿ƒç…§ç‰‡å¢™ â¤ï¸</h2>
      <p class="sub" style="margin:0 0 10px">æ¯æ¬¡éšæœºæŠ½ 8 å¼ ç»„æˆæ‹¼å›¾ï¼ˆç›¸å†Œä»æ˜¾ç¤ºå…¨éƒ¨ï¼‰ã€‚</p>
      <div class="heart-wrap">
        <div id="heartWall" class="heart-wall"></div>
      </div>
    </section>

    <!-- Mini Wishlist / Tasks -->
    <section class="card">
      <h2 style="margin:0 0 8px">æ„¿æœ›æ¸…å• Â· Mini Bucket List ğŸŒŸ</h2>
      <div class="grid m2">
        <div><input id="wishInput" placeholder="æ¯”å¦‚ï¼šä¸€èµ·å»çœ‹ä¸€åœºæ¼”å”±ä¼š" style="width:100%;padding:12px 14px;border:1px solid #f2c9da;border-radius:12px;" /></div>
        <div><button class="btn" id="addWish">æ·»åŠ </button></div>
      </div>
      <ul id="wishes" style="margin:12px 0 0; padding:0; list-style:none; display:grid; gap:8px"></ul>
    </section>

    <!-- Secret Message (Unlock by Answer) -->
    <section class="card">
      <h2 style="margin:0 0 8px">å°å½©è›‹ Â· Secret âœ¨</h2>
      <p style="margin:0 0 8px">å›ç­”ä¸€ä¸ªå…³äºæˆ‘ä»¬çš„é¢˜ç›®æ¥è§£é”æƒŠå–œï¼š</p>
      <div class="grid m2">
        <div>
          <label>æˆ‘ä»¬ç¬¬ä¸€æ¬¡è§é¢çš„åŸå¸‚æ˜¯ï¼Ÿ</label>
          <input id="riddle" placeholder="è¾“å…¥ç­”æ¡ˆâ€¦" style="width:100%;padding:12px 14px;border:1px solid #f2c9da;border-radius:12px;" />
        </div>
        <div><button class="btn" id="unlock">è§£é”</button></div>
      </div>
      <div id="secret" style="display:none; margin-top:12px">
        <p>ğŸ Surpriseï¼ç‚¹ä¸€ä¸‹é¡µé¢ä»»æ„ä½ç½®æœ‰çƒŸèŠ±ï½ è¿˜æœ‰ï¼š<a href="#" id="customLink">ç»™ä½ çš„ä¸“å±ä¾¿ç­¾</a></p>
      </div>
    </section>
  </main>

  <footer>
    Made with â¤ï¸ by <span id="sig">Jiajun</span> Â· <span id="year"></span>
  </footer>

  <!-- Audio -->
  <audio id="music" src="audio/our-song.mp3" preload="none"></audio>

  <script>
    // ===== å¯é€‰ï¼šå¦‚æœä½ æ„¿æ„ï¼Œæ‰‹åŠ¨å†™çœŸå®æ–‡ä»¶åï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰=====
    // ä¾‹ï¼šconst MANUAL_LIST = ['image/01.jpg','image/å¥¹çš„ç¬‘.JPG','image/æˆ‘ä»¬@æµ·è¾¹.png'];
    const MANUAL_LIST = []; // ç•™ç©ºåˆ™ä¸å¯ç”¨

    // ===== è‡ªåŠ¨å€™é€‰ï¼ˆæœ€å¤š 120 å¼ ï¼‰=====
    function buildCandidates(maxN = 120){
      const list = [];
      for(let i=1;i<=maxN;i++){
        const n1 = String(i);
        const n2 = String(i).padStart(2,'0');
        const n3 = String(i).padStart(3,'0');
        list.push(
          `image/${n2}.jpg`, `image/${n2}.jpeg`, `image/${n2}.png`, `image/${n2}.JPG`,
          `image/${n1}.jpg`, `image/${n1}.jpeg`, `image/${n1}.png`, `image/${n1}.JPG`,
          `image/${n3}.jpg`, `image/${n3}.jpeg`, `image/${n3}.png`, `image/${n3}.JPG`,
          `image/IMG_${n3}.JPG`, `image/IMG_${n3}.jpg`, `image/DSC_${n3}.JPG`, `image/DSC_${n3}.jpg`
        );
      }
      return list;
    }
    const AUTO_LIST = buildCandidates(120);

    const isFileProto = location.protocol === 'file:';
    const debugBox = document.getElementById('debugBox');

    function logChip(text, ok){
      const span = document.createElement('span');
      span.className = 'chip ' + (ok ? 'ok' : 'fail');
      span.textContent = text;
      debugBox.appendChild(span);
    }

    // ===== èµ„æºæ±  =====
    let AVAILABLE_SRCS = [];   // ç›¸å†Œå…¨éƒ¨å¯ç”¨å›¾
    let HEART_SRCS = [];       // æœ¬æ¬¡æŠ½ä¸­çš„ 8 å¼ 
    let OBJECT_URLS = [];      // é€šè¿‡æ–‡ä»¶å¤¹é€‰æ‹©äº§ç”Ÿçš„ä¸´æ—¶URLï¼Œç¦»å¼€é¡µé¢è¦ revoke

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function pickN(arr, n){ return shuffle(arr).slice(0, Math.min(n, arr.length)); }

    // ===== æ–¹å¼ Aï¼šæ–‡ä»¶å¤¹é€‰æ‹©ï¼ˆæœ€ç¨³ï¼‰=====
    document.getElementById('dirInput').addEventListener('change', (e)=>{
      // æ¸…ç†æ—§çš„ object URLs
      OBJECT_URLS.forEach(u=> URL.revokeObjectURL(u));
      OBJECT_URLS = [];

      const files = Array.from(e.target.files || []).filter(f => f.type.startsWith('image/'));
      if(!files.length){ alert('æœªé€‰æ‹©ä»»ä½•å›¾ç‰‡'); return; }
      AVAILABLE_SRCS = files.map(f => {
        const u = URL.createObjectURL(f);
        OBJECT_URLS.push(u);
        return u;
      });
      updateCount();
      fillGallery(AVAILABLE_SRCS);
      HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      buildHeartWall();
      debugBox.innerHTML = `<div class="mini">æ¥æºï¼šæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œå…± ${AVAILABLE_SRCS.length} å¼ ã€‚</div>`;
    });

    // ===== æ–¹å¼ Bï¼šæ‰‹åŠ¨åˆ—è¡¨ï¼ˆMANUAL_LISTï¼‰=====
    async function tryManualList(){
      if(!MANUAL_LIST.length) return false;
      const ok = await preloadList(MANUAL_LIST);
      if(ok.length){
        AVAILABLE_SRCS = ok;
        updateCount();
        fillGallery(AVAILABLE_SRCS);
        HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
        buildHeartWall();
        debugBox.innerHTML = `<div class="mini">æ¥æºï¼šæ‰‹åŠ¨åˆ—è¡¨ï¼Œå…± ${AVAILABLE_SRCS.length} å¼ ã€‚</div>`;
        return true;
      }
      return false;
    }

    // ===== æ–¹å¼ Cï¼šè‡ªåŠ¨çŒœæµ‹ï¼ˆAUTO_LISTï¼‰=====
    function preloadList(list){
      return new Promise((resolve)=>{
        if(!list || !list.length) return resolve([]);
        const ok=[], total = list.length;
        let done = 0;

        list.forEach(src=>{
          const img = new Image();
          img.onload = ()=>{ ok.push(src); done++; logChip(src, true); if(done===total) resolve(Array.from(new Set(ok))); };
          img.onerror = ()=>{ done++; if(done<=60) logChip(src, false); if(done===total) resolve(Array.from(new Set(ok))); };
          // file:// ä¸‹ä¸è¦åŠ é˜²ç¼“å­˜å‚æ•°
          img.src = src + (!isFileProto && !src.includes('?') ? ('?v=' + Date.now()) : '');
        });
      });
    }

    async function tryAutoList(){
      const ok = await preloadList(AUTO_LIST);
      if(ok.length){
        AVAILABLE_SRCS = ok;
        updateCount();
        fillGallery(AVAILABLE_SRCS);
        HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
        buildHeartWall();
        debugBox.insertAdjacentHTML('afterbegin', `<div class="mini">æ¥æºï¼šè‡ªåŠ¨åŒ¹é…ï¼Œå…± ${AVAILABLE_SRCS.length} å¼ ã€‚</div>`);
        return true;
      }else{
        debugBox.insertAdjacentHTML('afterbegin', `<div class="mini">è‡ªåŠ¨åŒ¹é…æœªæ‰¾åˆ°ä»»ä½•å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ï¼š<br>1) <code>index.html</code> ä¸ <code>image/</code> æ˜¯å¦åŒçº§ï¼›2) æ–‡ä»¶å/æ‰©å±•åå¤§å°å†™ï¼›3) å°è¯•â€œä»æ–‡ä»¶å¤¹é€‰æ‹©â€ï¼›4) æˆ–åœ¨ä»£ç é¡¶éƒ¨å¡«å†™ <code>MANUAL_LIST</code>ã€‚</div>`);
        return false;
      }
    }

    // ===== ç›¸å†Œæ¸²æŸ“ & ç¯ç®± =====
    function fillGallery(srcs){
      const g = document.getElementById('gallery');
      g.innerHTML = '';
      if(!srcs.length){
        // å…œåº•æ¼”ç¤ºå›¾ï¼ˆç¦»çº¿ç¯å¢ƒä¸ä¸€å®šèƒ½åŠ è½½ï¼‰
        srcs = [
          'https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1200&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1200&auto=format&fit=crop',
          'https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=1200&auto=format&fit=crop'
        ];
      }
      srcs.forEach(s=>{
        const im = document.createElement('img');
        im.src = s; im.alt = 'memory'; im.loading = 'lazy';
        g.appendChild(im);
      });

      const lb = document.getElementById('lightbox');
      const lbImg = lb.querySelector('img');
      g.onclick = (e)=>{
        if(e.target.tagName==='IMG'){ lbImg.src=e.target.src; lb.classList.add('open'); }
      };
      lb.onclick = ()=> lb.classList.remove('open');
    }

    // ===== çˆ±å¿ƒå¢™ =====
    function insideHeart(x, y){
      const a = x*x + y*y - 1;
      return (a*a*a - x*x*y*y*y) <= 0;
    }
    function buildHeartWall(){
      const wall = document.getElementById('heartWall');
      if(!wall) return;
      wall.innerHTML = '';

      const rect = wall.getBoundingClientRect();
      const W = rect.width, H = rect.height;
      const cols = Math.max(10, Math.min(18, Math.round(W / 60)));
      const tile = Math.floor(W / cols);
      const rows = Math.floor(H / tile);
      const cx = W/2, cy = H/2;
      const xPad = (W - cols*tile)/2 + tile/2;
      const yPad = (H - rows*tile)/2 + tile/2;

      if(!HEART_SRCS.length) HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      let k = 0;

      for(let r=0; r<rows; r++){
        for(let c=0; c<cols; c++){
          const px = xPad + c*tile;
          const py = yPad + r*tile;
          const xn =  (px - cx) / (W/2);
          const yn = -(py - cy) / (H/2) * 1.10;

          if(insideHeart(xn, yn)){
            const wrap = document.createElement('div');
            wrap.className = 'heart-tile';
            wrap.style.left = px + 'px';
            wrap.style.top  = py + 'px';
            const pad = 6;
            const size = tile - pad;
            wrap.style.width = size + 'px';
            wrap.style.height= size + 'px';
            wrap.style.setProperty('--r', (Math.random()*8-4).toFixed(2)+'deg');

            const img = document.createElement('img');
            img.src = HEART_SRCS[k % HEART_SRCS.length];
            img.alt = 'memory ' + (k+1);
            img.loading = 'lazy';

            wrap.appendChild(img);
            wall.appendChild(wrap);
            k++;
          }
        }
      }

      const lb = document.getElementById('lightbox');
      const lbImg = lb.querySelector('img');
      wall.onclick = (e)=>{
        const tile = e.target.closest('.heart-tile');
        if(tile){ lbImg.src = tile.querySelector('img').src; lb.classList.add('open'); }
      };
    }

    function updateCount(){
      document.getElementById('countLoaded').textContent = AVAILABLE_SRCS.length;
    }

    document.getElementById('reshuffleBtn').addEventListener('click', ()=>{
      if(!AVAILABLE_SRCS.length){ alert('è¿˜æ²¡æœ‰åŠ è½½åˆ°ä»»ä½•å›¾ç‰‡å“¦ï½'); return; }
      HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      buildHeartWall();
    });

    // ===== å…¶ä»–å·²æœ‰åŠŸèƒ½ =====
    const typeEl = document.getElementById('typewriter');
    const lines = ['æ„¿ä½ çš„æ¯ä¸€å¤©éƒ½è¢«æ¸©æŸ”ç›¸å¾…ã€‚','æ„Ÿè°¢ä½ æŠŠæ™®é€šæ—¥å­å˜æˆäº†èŠ‚æ—¥ã€‚','ç”Ÿæ—¥å¿«ä¹ï¼Œä»Šå¤©ä¸å¾€åçš„æ— é™ä¸ªä»Šå¤©ï¼'];
    let idx=0, char=0;
    (function tick(){ const cur = lines[idx]; typeEl.textContent = cur.slice(0, ++char);
      if(char === cur.length){ setTimeout(()=>{char=0; idx=(idx+1)%lines.length;}, 1000); }
      setTimeout(tick, 80); })();

    const hearts = document.querySelector('.hearts');
    setInterval(()=>{ const h=document.createElement('div'); h.className='heart'; const size = 8 + Math.random()*16;
      h.style.width=h.style.height=size+'px'; h.style.left = Math.random()*100+'vw'; h.style.bottom='-20px';
      h.style.animationDuration = (4 + Math.random()*4)+'s'; hearts.appendChild(h); setTimeout(()=>h.remove(), 8000); }, 600);

    const audio = document.getElementById('music');
    document.getElementById('playBtn').addEventListener('click', ()=>{ if(audio.paused){ audio.play().catch(()=>{}); } else { audio.pause(); } });

    const canvas = document.getElementById('fx'); const ctx = canvas.getContext('2d');
    function resize(){ canvas.width=innerWidth; canvas.height=innerHeight } addEventListener('resize', resize); resize();
    const sparks=[]; function shoot(x,y){ for(let i=0;i<60;i++){ const a=Math.random()*Math.PI*2, sp=2+Math.random()*5;
      sparks.push({x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:60+Math.random()*20, color:`hsl(${Math.random()*360},100%,70%)`}); } }
    addEventListener('click', e=>{ shoot(e.clientX, e.clientY); });
    (function loop(){ requestAnimationFrame(loop); ctx.clearRect(0,0,canvas.width,canvas.height);
      for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.life-=1; if(s.life<=0){ sparks.splice(i,1); continue }
        s.x+=s.vx; s.y+=s.vy; s.vy+=0.03; ctx.globalCompositeOperation='lighter'; ctx.fillStyle=s.color; ctx.beginPath(); ctx.arc(s.x,s.y,2,0,Math.PI*2); ctx.fill(); } })();
    document.getElementById('confettiBtn').addEventListener('click', ()=>{ for(let i=0;i<120;i++) shoot(Math.random()*innerWidth, innerHeight); });

    const birthday = new Date(new Date().getFullYear(), 10-1, 20, 0,0,0); const cdEl = document.getElementById('countdown');
    function updateCD(){ const now = new Date(); if(now>birthday) birthday.setFullYear(now.getFullYear()+1);
      const diff = birthday-now; const d=Math.floor(diff/86400000);
      const h=Math.floor(diff%86400000/3600000).toString().padStart(2,'0');
      const m=Math.floor(diff%3600000/60000).toString().padStart(2,'0');
      const s=Math.floor(diff%60000/1000).toString().padStart(2,'0');
      cdEl.textContent = `${d}å¤© ${h}:${m}:${s}`; }
    setInterval(updateCD, 1000); updateCD();

    document.getElementById('todayLabel').textContent = new Date().toLocaleDateString();
    document.getElementById('year').textContent = new Date().getFullYear();

    const wishesUl = document.getElementById('wishes'); const key='wishes-v1';
    const saved = JSON.parse(localStorage.getItem(key)||'[]');
    function renderWishes(){ wishesUl.innerHTML='';
      saved.forEach((t,i)=>{ const li=document.createElement('li'); li.className='card'; li.style.padding='10px 12px';
        li.innerHTML=`<span>${t}</span> <button style="float:right" data-i="${i}" class="btn small">å®Œæˆ</button>`;
        const btn=li.querySelector('button'); btn.style.padding='6px 10px'; btn.style.borderRadius='12px'; btn.style.background='#8a4a62';
        btn.addEventListener('click',()=>{ saved.splice(i,1); localStorage.setItem(key,JSON.stringify(saved)); renderWishes(); });
        wishesUl.appendChild(li); }); }
    renderWishes();
    document.getElementById('addWish').addEventListener('click',()=>{ const v=document.getElementById('wishInput').value.trim(); if(!v) return;
      saved.push(v); localStorage.setItem(key,JSON.stringify(saved)); document.getElementById('wishInput').value=''; renderWishes(); });

    document.getElementById('unlock').addEventListener('click',()=>{ const ans = document.getElementById('riddle').value.trim().toLowerCase();
      const ok = ["beijing","åŒ—äº¬","tokyo","ä¸œäº¬","shanghai","ä¸Šæµ·"];
      if(ok.includes(ans)){ document.getElementById('secret').style.display='block'; shoot(innerWidth/2, innerHeight/2); }
      else { alert('å†æƒ³æƒ³çœ‹ï½ æç¤ºï¼šåŸå¸‚å'); } });
    document.getElementById('customLink').addEventListener('click', (e)=>{ e.preventDefault();
      alert('è¿™é‡Œå¯ä»¥è·³è½¬åˆ°å¦ä¸€é¡µæˆ–ä¸‹è½½ç¤¼ç‰©æ–‡ä»¶ï½ åœ¨ index.html é‡Œæ›¿æ¢ link è¡Œä¸º'); });

    // ===== å¯åŠ¨æµç¨‹ï¼šA(ç›®å½•é€‰æ‹©) æˆ– B(æ‰‹åŠ¨åˆ—è¡¨) æˆ– C(è‡ªåŠ¨åŒ¹é…) =====
    (async function init(){
      if(await tryManualList()) return;
      await tryAutoList();
      // è‹¥ä»ä¸ºç©ºï¼Œä¿æŒç›¸å†Œä¸ºç©ºï¼›ä½ ä¹Ÿå¯åœ¨æ­¤è°ƒç”¨ fillGallery([]) èµ°æ¼”ç¤ºå›¾
      if(!AVAILABLE_SRCS.length){
        fillGallery([]); // èµ°ç½‘ç»œæ¼”ç¤ºå›¾ï¼ˆç¦»çº¿å¯èƒ½åŠ è½½ä¸åˆ°ï¼‰
      }
      HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      buildHeartWall();
    })();

    // é‡Šæ”¾ object URLs
    window.addEventListener('beforeunload', ()=>{ OBJECT_URLS.forEach(u=> URL.revokeObjectURL(u)); });
  </script>
</body>
</html>
