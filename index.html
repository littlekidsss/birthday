<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy Birthday, My Love â™¡</title>
  <meta name="description" content="For the one I love â€” a tiny website full of our memories." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fff7fb; --ink:#3b2a2f; --primary:#ff6fa3; --accent:#ffd1e1; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -100px, #ffe3ef 10%, transparent 50%),
        radial-gradient(1000px 600px at -20% -200px, #ffeef6 10%, transparent 50%), var(--bg);
    }
    a{color:var(--primary)}
    .container{max-width:960px; margin:0 auto; padding:24px}
    header{display:flex; flex-direction:column; align-items:center; gap:8px; padding:56px 16px 24px}
    .script{font-family:"Great Vibes", cursive; font-size:56px; color:#ef3f7f; text-shadow:0 2px 0 #fff}
    .sub{opacity:.8}
    .pill{background:var(--accent); color:#8a4a62; padding:6px 12px; border-radius:999px; font-weight:600}
    .btn{
      display:inline-flex; align-items:center; gap:8px; border:none; border-radius:999px;
      padding:12px 18px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(255,111,163,.35); transition:transform .1s ease
    }
    .btn:hover{transform:translateY(-1px)}
    .card{background:#fff; border:1px solid #f5dbe6; border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(255,111,163,.08)}
    footer{padding:40px 0 64px; text-align:center; opacity:.8}
    @media (max-width:720px){ .script{font-size:44px} }

    /* Heart collage (only 8 tiles) */
    .heart-wrap{display:flex; justify-content:center}
    .heart-wall{
      position:relative; width:min(92vw, 820px); aspect-ratio:1/1;
      overflow:hidden; border-radius:24px; background:#fff;
      border:1px solid #f5dbe6; box-shadow:0 10px 30px rgba(255,111,163,.08);
    }
    .heart-tile{
      position:absolute; transform:translate(-50%,-50%) rotate(var(--r,0deg));
      width:160px; height:160px; border-radius:20px; overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.12); transition:transform .15s ease, box-shadow .15s ease;
    }
    .heart-tile:hover{ transform:translate(-50%,-50%) rotate(var(--r,0deg)) scale(1.03); box-shadow:0 12px 28px rgba(0,0,0,.16) }
    .heart-tile img{ width:100%; height:100%; object-fit:cover; display:block }
    .empty-hint{color:#8a4a62; text-align:center; padding:12px}

    /* Gallery preview */
    .gallery{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; margin-top:8px}
    .gallery img{width:100%; height:90px; object-fit:cover; border-radius:10px}
    @media (max-width:720px){ .gallery{grid-template-columns:repeat(3,1fr)} }

    /* Lightbox */
    .lightbox{position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:40}
    .lightbox.open{display:flex}
    .lightbox img{max-width:90vw; max-height:80vh; border-radius:12px}

    /* Floating hearts + fireworks */
    .hearts{pointer-events:none; position:fixed; inset:0; overflow:hidden; z-index:10}
    .heart{position:absolute; width:14px; height:14px; transform:rotate(45deg); background:var(--primary); opacity:.6; animation:float 6s linear forwards}
    .heart:before,.heart:after{content:""; position:absolute; width:14px; height:14px; background:var(--primary); border-radius:50%}
    .heart:before{left:-7px} .heart:after{top:-7px}
    @keyframes float{0%{transform:translateY(0) rotate(45deg)} 100%{transform:translateY(-120vh) rotate(45deg); opacity:0}}
    canvas#fx{position:fixed; inset:0; pointer-events:none; z-index:20}
  </style>
</head>
<body>
  <div class="hearts" aria-hidden="true"></div>
  <canvas id="fx"></canvas>

  <header class="container">
    <span class="pill">ğŸ‚ Happy Birthday</span>
    <h1 class="script">ç»™æœ€çˆ±çš„ä½ </h1>
    <p class="sub">å€’è®¡æ—¶ï¼š<span id="countdown">--:--:--</span></p>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
      <label class="btn" for="dirInput">ğŸ“ ä»æ–‡ä»¶å¤¹é€‰æ‹©ï¼ˆé€‰ä¸­ image/ï¼‰</label>
      <input id="dirInput" type="file" webkitdirectory directory multiple accept="image/*" style="display:none" />
      <button class="btn" id="reshuffleBtn">ğŸ” æ¢ä¸€ç»„</button>
      <span class="sub">å·²åŠ è½½ï¼š<b id="countLoaded">0</b> å¼ </span>
    </div>
  </header>

  <main class="container" style="display:grid; gap:24px">
    <section class="card">
      <h2 style="margin:0 0 8px">çˆ±å¿ƒç…§ç‰‡å¢™ â¤ï¸ï¼ˆ8 å¼ ï¼‰</h2>
      <p class="sub" style="margin:0 0 10px">åªæ‘† <b>8</b> å¼ å›¾ï¼ŒæŒ‰çˆ±å¿ƒå½¢çŠ¶æ’åˆ—ã€‚ç‚¹å‡»â€œæ¢ä¸€ç»„â€éšæœºé‡æ’ã€‚</p>
      <div class="heart-wrap">
        <div id="heartWall" class="heart-wall">
          <div class="empty-hint">è¿˜æ²¡æœ‰åŠ è½½åˆ°å›¾ç‰‡ï½ å…ˆç‚¹â€œä»æ–‡ä»¶å¤¹é€‰æ‹©â€ï¼Œæˆ–æŠŠå›¾ç‰‡æ”¾åœ¨ <code>image/</code> å¹¶ä½¿ç”¨è‡ªåŠ¨åŒ¹é…ã€‚</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">ç›¸å†Œé¢„è§ˆï¼ˆå…¨éƒ¨å·²åŠ è½½å›¾ç‰‡ï¼‰</h3>
      <div id="gallery" class="gallery"></div>
      <div class="lightbox" id="lightbox"><img alt="preview" /></div>
    </section>
  </main>

  <footer>Made with â¤ï¸ by <span id="sig">Jiajun</span> Â· <span id="year"></span></footer>
  <audio id="music" src="audio/our-song.mp3" preload="none"></audio>

  <script>
    // ===== å°å·¥å…· =====
    const $ = s => document.querySelector(s);
    const isFileProto = location.protocol === 'file:';
    function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    function pickN(a,n){ return shuffle(a).slice(0, Math.min(n, a.length)) }
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)) }

    // ===== èµ„æºæ±  =====
    let AVAILABLE_SRCS = [];  // å…¨éƒ¨å¯ç”¨å›¾
    let HEART_SRCS = [];      // å½“å‰ 8 å¼ 
    let OBJECT_URLS = [];     // éœ€è¦ revoke

    // ===== è‡ªåŠ¨åŒ¹é… image/ ä¸‹å¸¸è§å‘½å =====
    function buildCandidates(maxN = 200){
      const list=[];
      for(let i=1;i<=maxN;i++){
        const n1=String(i), n2=String(i).padStart(2,'0'), n3=String(i).padStart(3,'0');
        list.push(
          `image/${n2}.jpg`,`image/${n2}.jpeg`,`image/${n2}.png`,`image/${n2}.JPG`,
          `image/${n1}.jpg`,`image/${n1}.jpeg`,`image/${n1}.png`,`image/${n1}.JPG`,
          `image/${n3}.jpg`,`image/${n3}.jpeg`,`image/${n3}.png`,`image/${n3}.JPG`,
          `image/IMG_${n3}.JPG`,`image/IMG_${n3}.jpg`,`image/DSC_${n3}.JPG`,`image/DSC_${n3}.jpg`
        );
      }
      return list;
    }
    const AUTO_LIST = buildCandidates(120);

    function preloadList(list){
      return new Promise((resolve)=>{
        if(!list.length) return resolve([]);
        const ok=[], total=list.length; let done=0;
        list.forEach(src=>{
          const img=new Image();
          img.onload = ()=>{ ok.push(src); if(++done===total) resolve(Array.from(new Set(ok))); };
          img.onerror= ()=>{ if(++done===total) resolve(Array.from(new Set(ok))); };
          img.src = src + (!isFileProto && !src.includes('?') ? ('?v='+Date.now()) : '');
        });
      });
    }

    // ===== ç›¸å†Œé¢„è§ˆ =====
    function fillGallery(srcs){
      const g = $('#gallery'); g.innerHTML='';
      srcs.forEach(s=>{ const im=document.createElement('img'); im.src=s; im.loading='lazy'; g.appendChild(im); });
      $('#countLoaded').textContent = srcs.length;

      const lb=$('#lightbox'), lbImg=lb.querySelector('img');
      g.onclick = (e)=>{ if(e.target.tagName==='IMG'){ lbImg.src=e.target.src; lb.classList.add('open'); } };
      lb.onclick = ()=> lb.classList.remove('open');
    }

    // ===== 8 å¼ çš„çˆ±å¿ƒå¢™ï¼ˆé”šç‚¹æ‘†æ”¾ï¼‰=====
    function buildHeartWall8(){
      const wall = $('#heartWall');
      if(!HEART_SRCS.length){ wall.innerHTML = '<div class="empty-hint">è¿˜æ²¡æœ‰åŠ è½½åˆ°å›¾ç‰‡å“¦ï½</div>'; return; }
      wall.innerHTML='';

      const rect = wall.getBoundingClientRect(), W = rect.width, H = rect.height;

      // 8 ä¸ªé”šç‚¹ï¼ˆ0~1 ç›¸å¯¹åæ ‡ï¼‰ï¼Œå¯æŒ‰éœ€è¦å¾®è°ƒ
      const anchors = [
        [0.30, 0.25], [0.70, 0.25], // é¡¶éƒ¨ä¸¤ä¾§
        [0.15, 0.45], [0.85, 0.45], // ä¸Šä¸­ä¸¤ä¾§
        [0.30, 0.65], [0.70, 0.65], // ä¸­éƒ¨ä¸¤ä¾§
        [0.50, 0.82],               // ä¸‹ä¸­
        [0.50, 0.93]                // å°–ç«¯
      ];

      // è‡ªé€‚åº”å°ºå¯¸ï¼Œé¿å…é‡å 
      const S = clamp(W * 0.18, 96, 180);
      const margin = 6;

      anchors.forEach((p,i)=>{
        const x = clamp(p[0] * W, S/2 + margin, W - S/2 - margin);
        const y = clamp(p[1] * H, S/2 + margin, H - S/2 - margin);

        const tile = document.createElement('div');
        tile.className = 'heart-tile';
        tile.style.left = x + 'px';
        tile.style.top  = y + 'px';
        tile.style.width  = S + 'px';
        tile.style.height = S + 'px';
        tile.style.setProperty('--r', (Math.random()*6-3).toFixed(2)+'deg');

        const img = document.createElement('img');
        img.src = HEART_SRCS[i % HEART_SRCS.length];
        img.alt = 'memory '+(i+1);
        img.loading='lazy';

        tile.appendChild(img);
        wall.appendChild(tile);
      });

      // ç‚¹å‡»çˆ±å¿ƒå— â†’ æ”¾å¤§é¢„è§ˆ
      const lb = $('#lightbox'); const lbImg = lb.querySelector('img');
      wall.onclick = (e)=>{ const t = e.target.closest('.heart-tile'); if(t){ lbImg.src = t.querySelector('img').src; lb.classList.add('open'); } };
    }

    // ===== ç›®å½•é€‰æ‹©ï¼ˆæœ€ç¨³ï¼‰=====
    $('#dirInput').addEventListener('change', (e)=>{
      // æ¸…ç†æ—§ object URLs
      OBJECT_URLS.forEach(u=>URL.revokeObjectURL(u)); OBJECT_URLS=[];
      const files = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
      if(!files.length){ alert('æœªé€‰æ‹©ä»»ä½•å›¾ç‰‡'); return; }
      AVAILABLE_SRCS = files.map(f=>{ const u = URL.createObjectURL(f); OBJECT_URLS.push(u); return u; });
      fillGallery(AVAILABLE_SRCS);
      HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      buildHeartWall8();
    });

    // ===== æ¢ä¸€ç»„ =====
    $('#reshuffleBtn').addEventListener('click', ()=>{
      if(!AVAILABLE_SRCS.length){ alert('è¿˜æ²¡æœ‰åŠ è½½åˆ°ä»»ä½•å›¾ç‰‡å“¦ï½'); return; }
      HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
      buildHeartWall8();
    });

    // ===== åˆå§‹åŒ–ï¼šè‡ªåŠ¨åŒ¹é… image/ï¼Œæ‰¾ä¸åˆ°å†æ‰‹é€‰ =====
    (async function init(){
      const ok = await preloadList(AUTO_LIST);
      if(ok.length){
        AVAILABLE_SRCS = ok;
        fillGallery(AVAILABLE_SRCS);
        HEART_SRCS = pickN(AVAILABLE_SRCS, 8);
        buildHeartWall8();
      }

      // è£…é¥°ï¼šå¹´ä»½ã€å€’è®¡æ—¶ã€çƒŸèŠ±ã€å°å¿ƒå¿ƒ
      document.getElementById('year').textContent = new Date().getFullYear();
      const cdEl = document.getElementById('countdown');
      const birthday = new Date(new Date().getFullYear(), 10-1, 20, 0,0,0); // æ”¹æˆä½ çš„æ—¥æœŸ
      function updateCD(){
        const now=new Date(); if(now>birthday) birthday.setFullYear(now.getFullYear()+1);
        const diff=birthday-now, d=Math.floor(diff/86400000),
          h=Math.floor(diff%86400000/3600000).toString().padStart(2,'0'),
          m=Math.floor(diff%3600000/60000).toString().padStart(2,'0'),
          s=Math.floor(diff%60000/1000).toString().padStart(2,'0');
        cdEl.textContent = `${d}å¤© ${h}:${m}:${s}`;
      }
      setInterval(updateCD,1000); updateCD();

      setInterval(()=>{ const h=document.createElement('div'); h.className='heart'; const size=8+Math.random()*16;
        h.style.width=h.style.height=size+'px'; h.style.left=Math.random()*100+'vw'; h.style.bottom='-20px';
        h.style.animationDuration=(4+Math.random()*4)+'s';
        document.querySelector('.hearts').appendChild(h); setTimeout(()=>h.remove(),8000); },600);

      const canvas=document.getElementById('fx'), ctx=canvas.getContext('2d');
      function resize(){ canvas.width=innerWidth; canvas.height=innerHeight } addEventListener('resize', resize); resize();
      const sparks=[];
      function shoot(x,y){ for(let i=0;i<60;i++){ const a=Math.random()*Math.PI*2, sp=2+Math.random()*5;
        sparks.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:60+Math.random()*20,color:`hsl(${Math.random()*360},100%,70%)`}); } }
      addEventListener('click', e=>{ shoot(e.clientX, e.clientY); });
      (function loop(){ requestAnimationFrame(loop); ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.life-=1; if(s.life<=0){ sparks.splice(i,1); continue }
          s.x+=s.vx; s.y+=s.vy; s.vy+=0.03; ctx.globalCompositeOperation='lighter'; ctx.fillStyle=s.color; ctx.beginPath(); ctx.arc(s.x,s.y,2,0,Math.PI*2); ctx.fill(); } })();
    })();

    // ===== æ¸…ç†å¯¹è±¡ URL =====
    window.addEventListener('beforeunload', ()=>{ OBJECT_URLS.forEach(u=> URL.revokeObjectURL(u)); });
  </script>
</body>
</html>
